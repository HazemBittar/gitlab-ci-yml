#

include:
  - /base_autodevops_simple.yml

#

.rule_before_release: &rule_before_release
  if: ($CI_COMMIT_BRANCH == 'master' && $AUTO_DEVOPS_RELEASE_AUTO && $CI_COMMIT_MESSAGE =~ /\(#\d+\)/) || $RELEASE
.rule_on_release: &rule_on_release
  if: $CI_COMMIT_TAG && $AUTO_DEVOPS_RELEASE_AUTO && $PRODUCTION == null && $RELEASE == null
.rule_on_feature_branch: &rule_on_feature_branch
  if: $CI_COMMIT_BRANCH != 'master' && $CI_COMMIT_TAG == null && $RELEASE == null
.rule_on_production: &rule_on_production
  if: $PRODUCTION && $CI_COMMIT_TAG

#

# Test1:
#   stage: .pre
#   script:
#     - echo OK
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /\(#\d+\)$/

# Test2:
#   stage: .pre
#   script:
#     - echo OK
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /\(\#\d+\)$/

# Test3:
#   stage: .pre
#   script:
#     - echo OK
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /\(#\d+\)/

# Test4:
#   stage: .pre
#   script:
#     - echo OK
#   rules:
#     - if: $CI_COMMIT_MESSAGE =~ /\(\#\d+\)/

Cache setup:
  extends:
    - .autodevops_install
  rules:
    - <<: *rule_before_release
      when: never
    - <<: *rule_on_production
      when: never
    - when: always

Lint:
  extends:
    - .autodevops_lint
  rules:
    - <<: *rule_before_release
      when: never
    - <<: *rule_on_production
      when: never
    - if: $AUTO_DEVOPS_QUALITY_CHECK_DISABLED
      when: never
    - if: $AUTO_DEVOPS_LINT_DISABLED
      when: never
    - when: on_success

Test:
  extends:
    - .autodevops_test
  rules:
    - <<: *rule_before_release
      when: never
    - <<: *rule_on_production
      when: never
    - if: $AUTO_DEVOPS_QUALITY_CHECK_DISABLED
      when: never
    - if: "$AUTO_DEVOPS_TEST_DISABLED"
      when: never
    - when: on_success

Build:
  extends:
    - .autodevops_build
  rules:
    - <<: *rule_before_release
      when: never
    - <<: *rule_on_production
      when: never
    - when: on_success

Register app:
  extends: .autodevops_register_image
  rules:
    # - <<: *rule_on_feature_branch
    #   when: on_success
    # - when: never
    - <<: *rule_before_release
      when: never
    - <<: *rule_on_release
      when: never
    - <<: *rule_on_production
      when: never
    - when: on_success

Register release:
  extends: .autodevops_register_image
  rules:
    - <<: *rule_on_release
      when: on_success
    - when: never

Notify Start:
  extends: .autodevops_notify_starting_deployment
  rules:
    - <<: *rule_before_release
      when: never
    - when: on_success

Deploy review:
  extends: .autodevops_review
  rules:
    # - <<: *rule_on_feature_branch
    #   when: on_success
    # - when: never
    - <<: *rule_before_release
      when: never
    - <<: *rule_on_release
      when: never
    - when: on_success

Deploy preprod:
  extends: .autodevops_preprod
  rules:
    - <<: *rule_on_release
      when: on_success
    - when: never

Trigger release:
  extends: .autodevops_trigger_release
  rules:
    - <<: *rule_before_release
      when: never
    - <<: *rule_on_release
      when: never
    - <<: *rule_on_production
      when: never
    - when: manual

Ship to prod:
  extends: .autodevops_trigger_production
  rules:
    - <<: *rule_on_release
      when: manual
    - when: never

Deploy prod:
  extends: .autodevops_production
  rules:
    - <<: *rule_on_production
      when: always
    - when: never

Stop review:
  extends: .autodevops_stop_review
  rules:
    # - <<: *rule_on_feature_branch
    #   when: manual
    # - when: never
    - <<: *rule_before_release
      when: never
    - <<: *rule_on_release
      when: never
    - when: manual

Stop preprod:
  extends: .autodevops_stop_preprod
  rules:
    - <<: *rule_on_release
      when: manual
    - when: never

Notify fail:
  extends: .autodevops_notify_fail
  rules:
    - <<: *rule_before_release
      when: never
    - when: on_failure

Notify success:
  extends: .autodevops_notify_success
  rules:
    - <<: *rule_before_release
      when: never
    - when: on_success

Release:
  extends: .autodevops_release
  rules:
    - <<: *rule_before_release
      when: always
    - when: never
