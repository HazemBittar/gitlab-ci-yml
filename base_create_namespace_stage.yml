#

.base_create_namespace_stage: &base_create_namespace_stage
  extends: .base_docker_kube_image_stage
  stage: "Registration"
  environment:
    name: $DEV_ENVIRONMENT_NAME
  script:
    - echo "Namespace "${K8S_NAMESPACE}" created"
  dependencies: []
  before_script:
    - *resolve_env_domain
    # Skip the job if the namespace exists
    - "[[ $(kubectl get namespace ${K8S_NAMESPACE}) ]] && exit ${CI_JOB_SKIP_EXIT_CODE:-0}"
    # Or (re)create to ensure new quota are applied
    # - kubectl delete namespaces ${K8S_NAMESPACE} || true
    #
    - kubectl create namespace ${K8S_NAMESPACE}
    - kubectl annotate namespace ${K8S_NAMESPACE} field.cattle.io/projectId=${RANCHER_PROJECT_ID}
    #
    # Fake rancher namespace creation
    - kubectl annotate namespace ${K8S_NAMESPACE} field.cattle.io/containerDefaultResourceLimit='{}'
    - kubectl annotate namespace ${K8S_NAMESPACE} field.cattle.io/creatorId=gitlab
    # Link the namespace to a git branch
    - kubectl annotate namespace ${K8S_NAMESPACE} git/branch=${CI_COMMIT_REF_NAME}
